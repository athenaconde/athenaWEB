---CONNECT TO ATHENA
CONNECT TO ATHENA;
-------------------BEGIN INSERT DUE RECEIVABLES---------------------------
INSERT INTO DATA.RECEIVABLE (SALESID, AMOUNTDUE, DUEDATE, BALANCE,
  ISPAID, DATECREATED, LASTMODIFIEDBYID, LASTMODIFIEDDATE)
  SELECT S.ID, S.TOTALPRICE / CASE WHEN I.MONTHSTOPAY = 0 THEN 1 ELSE I.MONTHSTOPAY END,
  S.SALESDATE + 1 MONTHS, S.TOTALPRICE, 0, CURRENT DATE, 21, CURRENT DATE
    FROM DATA.SALES AS S JOIN DATA.RECEIVABLEINTEREST AS I ON I.SALESID = S.ID
    WHERE S.ID NOT IN ((SELECT DATA.RECEIVABLE.SALESID
                FROM DATA.RECEIVABLE));

---------------------END INSERT-------------------------------
  ---*********BEGIN UPDATE RECEIVABLES**************************
BEGIN
DECLARE V_ID INT ;

DECLARE V_MONTHINTEREST DECIMAL(5,5) ;

DECLARE V_TOTALAMOUNT DECIMAL (9,2) ;
DECLARE GLOBAL TEMPORARY TABLE TEMPT
  (RECEIVALEID INT, INTEREST DECIMAL(5,5) , TOTALAMOUNT DECIMAL(9,2));

INSERT INTO TEMPT
  SELECT R.ID, I.MONTHINTEREST, S.TOTALPRICE
    FROM
         DATA.RECEIVABLE AS R JOIN DATA.RECEIVABLEINTEREST AS I ON I.SALESID = R.SALESID JOIN DATA.SALES AS S ON S.ID = R.SALESID
    WHERE (R.DUEDATE + 1 MONTHS) > CURRENT DATE AND R.ISPAID = 0;



DECLARE DUERECEIVABLES CURSOR FOR
  SELECT * FROM TEMPT
  OPEN DUERECEIVABLES;

FETCH DUERECEIVABLES INTO V_ID, V_MONTHINTEREST , V_TOTALAMOUNT;

WHILE V_SALESID>0 DO
  	  UPDATE DATA.RECEIVABLE
  		SET AMOUNTDUE = AMOUNTDUE + (V_TOTALAMOUNT * V_MONTHINTEREST) , 
  		DUEDATE = DUEDATE + 1 MONTHS
  	WHERE ID = V_ID
  	FETCH DUERECEIVABLES INTO V_ID, V_MONTHINTEREST , , V_TOTALAMOUNT;

	SET V_ID = IFNULL(V_ID,0);

  END WHILE

CLOSE DUERECEIVABLES;

END
----------------------END UPDATE-----------------------------------;
CONNECT RESET;